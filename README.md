**برنامه مدیریت اپلیکیشن‌ها در وب‌کمپوننت**

- **نویسنده**: احمد کنی
- **تاریخ**: 17 دی ۱۴۰۳  
- **وضعیت**: پیش‌نویس/~~در حال بررسی~~/~~تایید شده~~


---
## **مسئله**

در این درخواست برای نظر، می‌خواهیم یک برنامه‌ی سمت کلاینت را شرح دهیم که این قابلیت‌ها را داراست:
1. ارتباط بین کاربران امن است و کاربران می‌توانند فایل‌ها و برنامه‌ها را برای یکدیگر بفرستند و همچنین سمت خود کاربران این برنامه‌ها رمزنگاری شده است.
2. بعد از دریافت و به روزرسانی برنامه‌ها کاربران می‌توانند این برنامه‌ها را در میزکار خود اجرا کنند.

---
## **چالش‌ها**

1. رمزگذاری و امنیت فایل هایی که کاربر ذخیره، ویرایش یا منتقل میکند.
2. نحوه ی ذخیره سازی فایل ها به صورتی که برای اپلیکیشن ما قابل خوانش و اجرا باشد.
3. ایجاد ارتباط کاربر به کاربر بدون استفاده از سرور و استفاده از قابلیت‌های گیت بدون نیاز به سرور گیت از راه دور.

---

## **ارتباط دو کاربر**

برای شروع ارتباط هر کاربر به سرور signalling ما پیام می‌دهد، این سرور فقط برای شروع ارتباط مورد نیاز است و هیچ استفاده‌ی دیگری ندارد.
اطلاعات ذخیره شده در این سرور شامل ip هر کاربر و کلید عمومی مختص او است که این اطلاعات با تمام کاربران به اشتراک گذاشته می‌شود.
بعد از ارتباط کاربران با این سرور هر کاربر می‌تواند به طور مستقیم از طریق پروتکل webRTC با سایر کاربران ارتباط مستقیم برقرار کند و همچنین با استفاده از کلید عمومی کاربر طرف مقابل رمزگذاری را انجام دهد.
محتوای موجود در سرور می‌تواند یک فایل JSON به این شکل باشد:
```
{
	UserA: { ip: '1.1.1.1', publicKey: 'AJI87hrqi3wF92JFjfj8' },
	...
}
```

---

## **امنیت**

### 1. **رمزگذاری محتوای محلی**

برای رمزنگاری فایل‌های کاربر در قسمت محلی یا indexed db در مرورگر، فایل‌های مخزن کاربر را در هر بار خروج پاک میکنیم و با کلید خصوصی فایل .git را رمزنگاری می‌کنیم، کاربر در هر بار ورود دوباره فایل .git را رمزگشایی کرده و فایل‌های موجود در مخزن را بازیابی می‌کند.
### 2. **رمزنگاری برای انتقال**

1. **الگوریتم رمزگذاری:** برای اینکه یک انتقال امن صورت بگیرد از الگوریتم diffie-hellman استفاده می‌کنیم چون نه تنها امنیت کافی را داراست بلکه از یک الگوریتم متقارن استفاده می‌کند و سربار انتقال اطلاعات را کم می‌کند. برای این کار ابتدا کاربر اول کلید عمومی کاربر دوم را که روی سرور وجود دارد دریافت می‌کند و p و g را برای او می‌فرستد، البته باید این دو مقدار را با کلید خصوصی خود رمز کند تا کاربر دوم بتواند هویت کاربر اول را احراز کند.
   بعد از توافق روی مقادیر p, g کاربر اول کلید عمومی خود را تولید کرده و برای کاربر دوم میفرستد، همچنین کاربر دوم کلید عمومی خود را محاسبه می‌کند و برای کاربر اول می‌فرستد با این کار دو کاربر می‌توانند رمز مشترک را محاسبه کنند و برای انتقال‌های بعدی استفاده کنند.
   
2. **روش‌های انتقال:** هر کاربر به دو صورت می‌تواند فایل‌ها را دریافت کند، یک اینکه درخواست بدهد و فایل‌ها را از کاربر مورد نظر بگیرد، یا اینکه کاربر ثانویه فایل‌ها را برای او بفرستد و به اشتراک بگذارد. در حالت اول کاربر درخواست خود مبتنی بر اینکه چه فایل‌هایی را نیاز دارد به کاربر دوم می‌فرستد و در صورتی که کاربر دوم اجازه‌ی دسترسی به کاربر اول بدهد فایل‌های مورد نیاز او را در یک مخزن مجزا با نام کاربر اول ایجاد می‌کند و فایل .git را با رمز مشترک بین دو کاربر رمزگذاری کرده و برای او می‌فرستد.
   برای حالت دوم نیز کاربر اول فایل .git رمز شده با رمز مشترک بین کاربر اول و دوم را برای کاربر دوم می‌فرستد.
### 3. **یکپارچگی اطلاعات

برای اطمینان از یکپارچگی اطلاعات چند مورد را بررسی می‌کنیم:
1. **امضای فایل:** وقتی کاربری یک فایل را از کاربر مقابل دریافت می‌کند، با رمز مشترک این فایل را باز می‌کند، برای اطمینان بیشتر از یکپارچگی کاربری که فایل را می‌فرستد می‌تواند قبل از رمزنگاری فایل با رمز مشترکی که با کاربر دوم دارد، فایل را با کلید خصوصی خود امضا کند تا کاربری که فایل را دریافت می‌کند پس از رمزگشایی با رمز مشترک یک بار دیگر چک کند که این فایل توسط همان کاربر امضا شده یا خیر.
2. **استفاده از قابلیت گیت:** وقتی کاربر فایل .git را رمزگشایی کرد، در صورتی که فایل دست‌خورده باشد، برای استفاده از فایل‌ها و بازیابیشان به مشکل خواهد خورد که این همان یکپارچگی اطلاعات فایل‌ها را برای کاربر دارد.
### 4. **دسترسی**

برای کنترل دسترسی چند پیشنهاد مطرح می‌کنیم:
1. **واکشی مخزن برای بار اول:**
	1. **استفاده از Branching:** به این صورت که وقتی می‌خواهیم یک مخزن را با یک کاربر به اشتراک بگذاریم یک branch با نام او ساخته می‌شود و فقط فایل‌هایی که حق دسترسی دارد را به آن اضافه می‌کنیم. سپس سایر شاخه‌ها را حذف می‌کنیم و فایل .git را رمزگذاری کرده و برای کاربر می‌فرستیم. برای بازگشت به حالت قبل می‌توانیم از git reset hard استفاده کنیم.
	2. **ایجاد یک مخزن جدید:** برای هر کاربر یک مخزن جدید ایجاد می‌کنیم و یک فایل .git مربوط به او داریم، سپس آن فایل را رمزگذاری و برای کاربر ارسال می‌کنیم.
2. **به‌روزرسانی مخزن:** برای این کار در صورتی که یک کاربر بخواهد فایل‌های تغییر داده شده را به کاربر دوم برساند می‌توانیم فقط object های مربوط به تغییرات جدید را یا کل فایل .git را برای کاربر نهایی ارسال کنیم.

---

## **خوانش و نگارش فایل‌ها**

برای شبیه‌سازی عملیات خوانش فایل برای هر کاربر، در گیت این عملیات باید انجام شود: 
1. بعد از رمزگشایی فایل .git، فایل ها را با دستور git reset --hard HEAD~1 بازیابی خواهیم کرد، با این کار فایل‌هایی که کاربر اول پاک کرده بود تا فایل .git را به تنهایی ارسال کند بازیابی خواهند شد.
2. سپس کاربر می‌تواند به تمام فایل‌ها و پوشه‌هایشان دسترسی داشته باشد و آن‌ها را بخواند.
3. پاک کردن تمام فایل‌ها و رمزنگاری فایل .git

برای شبیه‌سازی عملیات نگارش فایل برای هر کاربر، در گیت این عملیات باید انجام شود: 
1. استفاده از دستور writFile برای نوشتن فایل در حافظه‌ی محلی
2. استفاده از git add برای اضافه کردن فایل به staging area
3. استفاده از git commit برای نسخه زدن و اضافه کردن فایل به محیط git directory
4. پاک کردن تمام فایل‌ها و رمزنگاری فایل .git

---
## **مدل چینش فایل**

مدل چینش فایل ها برای اجرای برنامه ها به این صورت خواهد بود که کاربر یک فایل config.json برای ما آماده میکند، این فایل شامل اطلاعات مهم برای bundle کردن و همچنین اطلاعات کاربردی درباره‌ی برنامه ی مورد نظر و محل فایل های مهم پروژه است.
به عنوان نمونه، یک فایل config.json میتواند شامل این موارد باشد: 
```
{
  "entry": "main.js",
  "output": "bundle.js",
  "type": "module",
  "app": {"type": "web component", "name": "my-wc", "html": "index.html"},
  "package": "package.json",
  
}
```
با استفاده از این فایل میتوانیم فایل ورودی و فایل خروجی را بگیریم و انواع مختلف application ها را با آن اجرا کنیم. همچنین میتوان بسته‌های داخل package را به صورت cdn یا محلی نصب کنیم و اجازه‌ی استفاده از آن‌ها را به کاربر بدهیم.

---
## **نکته پایانی**

این RFC روشی برای مدیریت و بارگذاری انواع اپلیکیشن‌ها در یک وب‌کمپوننت سمت کاربر ارائه می‌دهد. لطفاً نظرات، پیشنهادات و انتقادات خود را ارائه دهید تا این طرح بهبود یابد.  

---

### **چگونه به این RFC نظر بدهید؟**

- نظرات و پیشنهادات خود را در قالب Issue در مخزن پروژه ارسال کنید.  
